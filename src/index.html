<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kammi</title>
    <style>
        /* ========================================
       CSS VARIABLES - Theme controlled
       ======================================== */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #c4b69c;
            --text-color-dim: rgba(196, 182, 156, 0.4);
            --font-family: Georgia, serif;
            --font-size: 20px;
            --line-height: 1.8;
            --transition-speed: 1200ms;
        }

        /* ========================================
       RESET & BASE
       ======================================== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: var(--font-size);
            line-height: var(--line-height);
        }

        ::-webkit-scrollbar {
            display: none;
        }

        * {
            scrollbar-width: none;
        }

        /* ========================================
       SCREENS (shared)
       ======================================== */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease,
                visibility var(--transition-speed) ease;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }

        /* ========================================
       ONBOARDING: NAME
       ======================================== */
        #onboarding-name .onboarding-title {
            font-size: 1.4em;
            font-style: italic;
            margin-bottom: 2rem;
        }

        .onboarding-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--text-color-dim);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1.2em;
            text-align: center;
            padding: 0.5rem;
            width: 300px;
            outline: none;
        }

        .onboarding-input:focus {
            border-color: var(--text-color);
        }

        .onboarding-hint {
            margin-top: 2rem;
            font-size: 0.8em;
            color: var(--text-color-dim);
        }

        /* ========================================
       ONBOARDING: THEME
       ======================================== */
        #onboarding-theme .theme-title {
            font-size: 1.2em;
            margin-bottom: 2rem;
        }

        .theme-options {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .theme-option {
            width: 140px;
            height: 100px;
            border: 2px solid var(--text-color-dim);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            transition: border-color 0.3s, transform 0.2s;
        }

        .theme-option:hover {
            border-color: var(--text-color);
            transform: scale(1.05);
        }

        .theme-option.selected {
            border-color: var(--text-color);
            border-width: 3px;
        }

        .theme-continue {
            margin-top: 2rem;
            padding: 0.8rem 2rem;
            background: transparent;
            border: 1px solid var(--text-color-dim);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1em;
            cursor: pointer;
            opacity: 0.3;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .theme-continue.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .theme-continue.enabled:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-midnight {
            background: #1a1a1a;
            color: #c4b69c;
        }

        .theme-paper {
            background: #f5f5dc;
            color: #3d3d3d;
        }

        .theme-focus {
            background: #ffffff;
            color: #1a1a1a;
        }

        .theme-custom {
            background: linear-gradient(135deg, #1a1a1a 50%, #f5f5dc 50%);
            color: #888;
        }

        /* ========================================
       GREETING SCREEN
       ======================================== */
        #greeting-screen {
            cursor: pointer;
        }

        .greeting-text {
            font-size: 1.6em;
            font-style: italic;
        }

        .greeting-hint {
            margin-top: 3rem;
            font-size: 0.8em;
            color: var(--text-color-dim);
        }

        /* ========================================
       WRITING SCREEN
       ======================================== */
        #writing-screen {
            padding: 15vh 10vw;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .writing-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: var(--font-size);
            line-height: var(--line-height);
            resize: none;
            caret-color: var(--text-color-dim);
        }

        .writing-textarea::placeholder {
            color: transparent;
        }

        /* ========================================
       COGWHEEL (settings shortcut)
       ======================================== */
        .cogwheel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            opacity: 0.1;
            cursor: pointer;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .cogwheel:hover {
            opacity: 0.5;
        }

        .cogwheel svg {
            fill: var(--text-color);
            width: 100%;
            height: 100%;
        }

        /* ========================================
       ESC MENU
       ======================================== */
        #menu-screen {
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
        }

        .menu-items {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            text-align: center;
        }

        .menu-item {
            font-size: 1.1em;
            color: var(--text-color);
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .menu-item:hover {
            opacity: 0.7;
        }

        /* ========================================
       SETTINGS PANEL
       ======================================== */
        #settings-screen {
            background: var(--bg-color);
            z-index: 200;
            padding: 5vh 10vw;
            align-items: flex-start;
            overflow-y: auto;
        }

        .settings-title {
            font-size: 1.4em;
            margin-bottom: 2rem;
        }

        .settings-group {
            margin-bottom: 2rem;
            width: 100%;
            max-width: 600px;
        }

        .settings-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
            color: var(--text-color-dim);
        }

        .settings-input,
        .settings-select {
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--text-color-dim);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1em;
            outline: none;
        }

        .settings-input:focus,
        .settings-select:focus {
            border-color: var(--text-color);
        }

        .settings-color-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .settings-color-picker {
            width: 50px;
            height: 40px;
            border: none;
            cursor: pointer;
        }

        .settings-slider {
            width: 100%;
        }

        .settings-actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }

        .settings-btn {
            padding: 0.6rem 1.2rem;
            background: transparent;
            border: 1px solid var(--text-color-dim);
            color: var(--text-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>

    <!-- ONBOARDING: Name -->
    <div id="onboarding-name" class="screen">
        <p class="onboarding-title">Welcome to Kammi.</p>
        <input type="text" id="name-input" class="onboarding-input" placeholder="What should I call you?" autofocus>
        <p class="onboarding-hint">Press Enter to continue</p>
    </div>

    <!-- ONBOARDING: Theme -->
    <div id="onboarding-theme" class="screen">
        <p class="theme-title">Choose your atmosphere</p>
        <div class="theme-options">
            <div class="theme-option theme-midnight" data-theme="midnight">Midnight</div>
            <div class="theme-option theme-paper" data-theme="paper">Paper</div>
            <div class="theme-option theme-focus" data-theme="focus">Focus</div>
            <div class="theme-option theme-custom" data-theme="custom">Custom</div>
        </div>
        <button class="theme-continue" id="theme-continue">Continue</button>
    </div>

    <!-- GREETING -->
    <div id="greeting-screen" class="screen">
        <p class="greeting-text" id="greeting-text"></p>
        <div id="greeting-options" style="margin-top: 2rem; text-align: center;">
            <p id="greeting-continue" style="cursor: pointer; margin-bottom: 1rem; display: none;">Continue your last
                piece</p>
            <p id="greeting-new" class="greeting-hint" style="cursor: pointer;">Start new</p>
        </div>
    </div>

    <!-- WRITING -->
    <div id="writing-screen" class="screen">
        <textarea id="writing-textarea" class="writing-textarea" spellcheck="false"></textarea>
    </div>

    <!-- COGWHEEL -->
    <div class="cogwheel" id="cogwheel" title="Settings">
        <svg viewBox="0 0 24 24">
            <path
                d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96a7.09 7.09 0 00-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.49.37 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.61 3.61 0 018.4 12 3.61 3.61 0 0112 8.4a3.61 3.61 0 013.6 3.6 3.61 3.61 0 01-3.6 3.6z" />
        </svg>
    </div>

    <!-- ESC MENU -->
    <div id="menu-screen" class="screen">
        <div class="menu-items">
            <div class="menu-item" id="menu-resume">Resume</div>
            <div class="menu-item" id="menu-settings">Settings</div>
            <div class="menu-item" id="menu-privacy">Privacy</div>
            <div class="menu-item" id="menu-support">Support</div>
            <div class="menu-item" id="menu-quit" style="margin-top: 1rem; opacity: 0.6;">Quit</div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings-screen" class="screen">
        <h2 class="settings-title">Settings</h2>

        <div class="settings-group">
            <label class="settings-label">Your Name</label>
            <input type="text" id="settings-name" class="settings-input">
        </div>

        <div class="settings-group">
            <label class="settings-label">Quick Themes</label>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div class="theme-preset" data-theme="midnight"
                    style="width: 80px; height: 50px; background: #1a1a1a; color: #c4b69c; border: 1px solid var(--text-color-dim); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75em;">
                    Midnight</div>
                <div class="theme-preset" data-theme="paper"
                    style="width: 80px; height: 50px; background: #f5f5dc; color: #3d3d3d; border: 1px solid var(--text-color-dim); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75em;">
                    Paper</div>
                <div class="theme-preset" data-theme="focus"
                    style="width: 80px; height: 50px; background: #ffffff; color: #1a1a1a; border: 1px solid var(--text-color-dim); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75em;">
                    Focus</div>
            </div>
        </div>

        <div class="settings-group">
            <label class="settings-label">Font</label>
            <div id="font-options" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div class="font-option" data-font="Georgia, serif"
                    style="font-family: Georgia, serif; padding: 0.5rem; border: 1px solid var(--text-color-dim); cursor: pointer;">
                    Georgia - The quick brown fox</div>
                <div class="font-option" data-font="'Times New Roman', serif"
                    style="font-family: 'Times New Roman', serif; padding: 0.5rem; border: 1px solid var(--text-color-dim); cursor: pointer;">
                    Times New Roman - The quick brown fox</div>
                <div class="font-option" data-font="Inter, sans-serif"
                    style="font-family: Inter, sans-serif; padding: 0.5rem; border: 1px solid var(--text-color-dim); cursor: pointer;">
                    Inter - The quick brown fox</div>
                <div class="font-option" data-font="Arial, sans-serif"
                    style="font-family: Arial, sans-serif; padding: 0.5rem; border: 1px solid var(--text-color-dim); cursor: pointer;">
                    Arial - The quick brown fox</div>
                <div class="font-option" data-font="'Courier New', monospace"
                    style="font-family: 'Courier New', monospace; padding: 0.5rem; border: 1px solid var(--text-color-dim); cursor: pointer;">
                    Courier New - The quick brown fox</div>
            </div>
            <input type="hidden" id="settings-font" value="Georgia, serif">
        </div>

        <div class="settings-group">
            <label class="settings-label">Font Size: <span id="font-size-value">20</span>px</label>
            <input type="range" id="settings-fontsize" class="settings-slider" min="14" max="32" value="20">
            <div id="font-size-preview"
                style="margin-top: 0.5rem; padding: 0.5rem; border: 1px dashed var(--text-color-dim); font-size: 20px;">
                Preview text at this size
            </div>
        </div>

        <div class="settings-group">
            <label class="settings-label">Background Color</label>
            <div class="settings-color-row">
                <input type="color" id="settings-bgcolor" class="settings-color-picker" value="#1a1a1a">
                <input type="text" id="settings-bgcolor-hex" class="settings-input" value="#1a1a1a" style="width:120px">
            </div>
        </div>

        <div class="settings-actions">
            <button class="settings-btn" id="settings-save">Save</button>
            <button class="settings-btn" id="settings-cancel">Cancel</button>
        </div>
    </div>

    <script>
        // ========================================
        // STATE
        // ========================================
        let settings = null;
        let currentScreen = 'loading';
        let sessionFilename = '';
        let saveTimeout = null;
        let selectedTheme = null;  // For onboarding preview
        const AUTOSAVE_DELAY = 1000;

        // Theme presets
        const THEMES = {
            midnight: { fontFamily: 'Georgia, serif', fontSize: 20, bgColor: '#1a1a1a', textColor: '#c4b69c' },
            paper: { fontFamily: "'Times New Roman', serif", fontSize: 20, bgColor: '#f5f5dc', textColor: '#3d3d3d' },
            focus: { fontFamily: 'Inter, sans-serif', fontSize: 20, bgColor: '#ffffff', textColor: '#1a1a1a' }
        };

        // DOM
        const screens = {
            onboardingName: document.getElementById('onboarding-name'),
            onboardingTheme: document.getElementById('onboarding-theme'),
            greeting: document.getElementById('greeting-screen'),
            writing: document.getElementById('writing-screen'),
            menu: document.getElementById('menu-screen'),
            settings: document.getElementById('settings-screen')
        };

        const els = {
            nameInput: document.getElementById('name-input'),
            greetingText: document.getElementById('greeting-text'),
            textarea: document.getElementById('writing-textarea'),
            cogwheel: document.getElementById('cogwheel'),
            settingsName: document.getElementById('settings-name'),
            settingsFont: document.getElementById('settings-font'),
            settingsFontsize: document.getElementById('settings-fontsize'),
            settingsBgcolor: document.getElementById('settings-bgcolor'),
            settingsBgcolorHex: document.getElementById('settings-bgcolor-hex'),
            fontSizeValue: document.getElementById('font-size-value')
        };

        // ========================================
        // UTILITIES
        // ========================================
        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
            currentScreen = name;

            // Show cogwheel only during writing
            els.cogwheel.style.display = (name === 'writing') ? 'block' : 'none';
        }

        function getContrastColor(bgHex) {
            const r = parseInt(bgHex.slice(1, 3), 16);
            const g = parseInt(bgHex.slice(3, 5), 16);
            const b = parseInt(bgHex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#2d2d2d' : '#e8e0d0';
        }

        function applyTheme(theme) {
            document.documentElement.style.setProperty('--bg-color', theme.bgColor);
            document.documentElement.style.setProperty('--text-color', theme.textColor);
            document.documentElement.style.setProperty('--text-color-dim', theme.textColor + '66');
            document.documentElement.style.setProperty('--font-family', theme.fontFamily);
            document.documentElement.style.setProperty('--font-size', theme.fontSize + 'px');
        }

        function getTimeGreeting() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'Good morning';
            if (hour >= 12 && hour < 17) return 'Good afternoon';
            if (hour >= 17 && hour < 21) return 'Good evening';
            return 'Good night';
        }

        function generateSessionFilename() {
            const date = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate();
            let suffix = 'th';
            if (day % 10 === 1 && day !== 11) suffix = 'st';
            else if (day % 10 === 2 && day !== 12) suffix = 'nd';
            else if (day % 10 === 3 && day !== 13) suffix = 'rd';
            let hours = date.getHours();
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12 || 12;
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `On ${day}${suffix} of ${months[date.getMonth()]}, ${date.getFullYear()}, ${hours}-${minutes} ${ampm}.txt`;
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        async function init() {
            const result = await window.kammi.getSettings();
            if (!result.success) {
                console.error('Failed to load settings');
                return;
            }

            settings = result.settings;

            // First launch? Start onboarding
            if (!settings.name) {
                showScreen('onboardingName');
                els.nameInput.focus();
            } else {
                // Apply theme and go to greeting
                const theme = settings.theme === 'custom' ? settings.customTheme : THEMES[settings.theme];
                applyTheme(theme);
                showGreeting();
            }

            setupEventListeners();
        }

        function setupEventListeners() {
            // Onboarding: Name
            els.nameInput.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' && els.nameInput.value.trim()) {
                    settings.name = els.nameInput.value.trim();
                    showScreen('onboardingTheme');
                }
            });

            // Onboarding: Theme selection (PREVIEW, not instant select)
            const themeContinueBtn = document.getElementById('theme-continue');
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    const themeName = opt.dataset.theme;
                    selectedTheme = themeName;

                    // Update visual selection
                    document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');

                    // Preview the theme
                    if (themeName !== 'custom') {
                        applyTheme(THEMES[themeName]);
                    }

                    // Enable continue button
                    themeContinueBtn.classList.add('enabled');
                });
            });

            // Continue button (after theme selection)
            themeContinueBtn.addEventListener('click', async () => {
                if (!selectedTheme) return;

                settings.theme = selectedTheme;

                if (selectedTheme === 'custom') {
                    settings.customTheme = { fontFamily: 'Arial, sans-serif', fontSize: 20, bgColor: '#ffffff', textColor: '#1a1a1a' };
                    applyTheme(settings.customTheme);
                    openSettings();
                } else {
                    await window.kammi.saveSettings(settings);
                    showGreeting();
                }
            });

            // Greeting: Continue vs New
            document.getElementById('greeting-continue').addEventListener('click', continueLastSession);
            document.getElementById('greeting-new').addEventListener('click', startNewSession);

            // ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (currentScreen === 'writing') {
                        showScreen('menu');
                    } else if (currentScreen === 'menu' || currentScreen === 'settings') {
                        resumeWriting();
                    }
                }
            });

            // Cogwheel
            els.cogwheel.addEventListener('click', openSettings);

            // Menu items
            document.getElementById('menu-resume').addEventListener('click', resumeWriting);
            document.getElementById('menu-settings').addEventListener('click', openSettings);
            document.getElementById('menu-privacy').addEventListener('click', () => alert('Privacy Policy coming soon'));
            document.getElementById('menu-support').addEventListener('click', () => alert('Support: hello@kammi.app'));
            document.getElementById('menu-quit').addEventListener('click', () => window.close());

            // Settings controls - LIVE PREVIEW on all changes
            els.settingsFontsize.addEventListener('input', () => {
                const size = els.settingsFontsize.value;
                els.fontSizeValue.textContent = size;
                document.getElementById('font-size-preview').style.fontSize = size + 'px';
                applyLivePreview();
            });

            els.settingsBgcolor.addEventListener('input', () => {
                els.settingsBgcolorHex.value = els.settingsBgcolor.value;
                applyLivePreview();
            });

            els.settingsBgcolorHex.addEventListener('input', () => {
                if (/^#[0-9A-Fa-f]{6}$/.test(els.settingsBgcolorHex.value)) {
                    els.settingsBgcolor.value = els.settingsBgcolorHex.value;
                    applyLivePreview();
                }
            });

            // Helper: Apply live preview from current form values
            function applyLivePreview() {
                const liveTheme = {
                    fontFamily: els.settingsFont.value,
                    fontSize: parseInt(els.settingsFontsize.value),
                    bgColor: els.settingsBgcolor.value,
                    textColor: getContrastColor(els.settingsBgcolor.value)
                };
                applyTheme(liveTheme);
            }

            // Font option clicks
            document.querySelectorAll('.font-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    // Update visual selection
                    document.querySelectorAll('.font-option').forEach(o => {
                        o.style.borderColor = 'var(--text-color-dim)';
                        o.style.borderWidth = '1px';
                    });
                    opt.style.borderColor = 'var(--text-color)';
                    opt.style.borderWidth = '2px';

                    // Update hidden input and apply live
                    els.settingsFont.value = opt.dataset.font;
                    applyLivePreview();
                });
            });

            // Theme preset clicks in Settings
            document.querySelectorAll('.theme-preset').forEach(preset => {
                preset.addEventListener('click', () => {
                    const themeName = preset.dataset.theme;
                    const theme = THEMES[themeName];

                    // Update form values to match preset
                    els.settingsBgcolor.value = theme.bgColor;
                    els.settingsBgcolorHex.value = theme.bgColor;
                    els.settingsFont.value = theme.fontFamily;
                    els.settingsFontsize.value = theme.fontSize;
                    els.fontSizeValue.textContent = theme.fontSize;
                    document.getElementById('font-size-preview').style.fontSize = theme.fontSize + 'px';

                    // Visual feedback on font options
                    document.querySelectorAll('.font-option').forEach(o => {
                        o.style.borderColor = o.dataset.font === theme.fontFamily ? 'var(--text-color)' : 'var(--text-color-dim)';
                        o.style.borderWidth = o.dataset.font === theme.fontFamily ? '2px' : '1px';
                    });

                    // Apply live preview
                    applyLivePreview();
                });
            });

            document.getElementById('settings-save').addEventListener('click', saveSettings);
            document.getElementById('settings-cancel').addEventListener('click', resumeWriting);

            // Auto-save on typing
            els.textarea.addEventListener('input', handleInput);
        }

        // ========================================
        // SCREEN HANDLERS
        // ========================================
        function showGreeting() {
            els.greetingText.textContent = `${getTimeGreeting()}, ${settings.name}`;

            // Show Continue option if there's a last session
            const continueBtn = document.getElementById('greeting-continue');
            const newBtn = document.getElementById('greeting-new');

            if (settings.lastSessionFile) {
                continueBtn.style.display = 'block';
                newBtn.textContent = 'Start new';
            } else {
                continueBtn.style.display = 'none';
                newBtn.textContent = 'Click anywhere to begin';
            }

            showScreen('greeting');
        }

        async function continueLastSession() {
            sessionFilename = settings.lastSessionFile;

            // Load content from last session
            const result = await window.kammi.readContent(sessionFilename);
            if (result.success) {
                els.textarea.value = result.content;
            }

            startWriting();
        }

        function startNewSession() {
            sessionFilename = generateSessionFilename();
            els.textarea.value = '';
            startWriting();
        }

        function startWriting() {
            showScreen('writing');
            els.textarea.focus();
            requestAnimationFrame(() => els.textarea.focus());
        }

        function resumeWriting() {
            showScreen('writing');
            els.textarea.focus();
        }

        function openSettings() {
            const theme = settings.theme === 'custom' ? settings.customTheme : THEMES[settings.theme];
            els.settingsName.value = settings.name;
            els.settingsFont.value = theme.fontFamily;
            els.settingsFontsize.value = theme.fontSize;
            els.fontSizeValue.textContent = theme.fontSize;
            els.settingsBgcolor.value = theme.bgColor;
            els.settingsBgcolorHex.value = theme.bgColor;
            showScreen('settings');
        }

        async function saveSettings() {
            settings.name = els.settingsName.value.trim() || settings.name;
            settings.theme = 'custom';
            settings.customTheme = {
                fontFamily: els.settingsFont.value,
                fontSize: parseInt(els.settingsFontsize.value),
                bgColor: els.settingsBgcolor.value,
                textColor: getContrastColor(els.settingsBgcolor.value)
            };

            applyTheme(settings.customTheme);
            await window.kammi.saveSettings(settings);
            resumeWriting();
        }

        // ========================================
        // AUTO-SAVE
        // ========================================
        function handleInput() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const content = els.textarea.value;
                if (!content.trim()) return;

                // Save content
                await window.kammi.saveContent(sessionFilename, content);

                // Store this as the last session (for resume)
                if (settings.lastSessionFile !== sessionFilename) {
                    settings.lastSessionFile = sessionFilename;
                    await window.kammi.saveSettings(settings);
                }
            }, AUTOSAVE_DELAY);
        }

        // Start
        init();
    </script>
</body>

</html>